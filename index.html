<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Saturno em RA ‚Äî Narra√ß√£o por voz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root { --bg:#0b0b0b; --ink:#e8e8e8; --muted:#9aa0a6; --card:#121212; --accent:#3b82f6; }
    * { box-sizing: border-box; }
    body { margin:0; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; min-height:100vh; display:flex; flex-direction:column; }
    header { padding:16px; text-align:center; }
    model-viewer { width:100%; height:62vh; background:#000; }
    .toolbar { display:flex; gap:8px; justify-content:center; padding:10px; flex-wrap:wrap; }
    .toolbar button {
      padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; cursor:pointer;
      background:var(--accent); color:white; font-weight:600;
    }
    .toggles { display:flex; gap:8px; justify-content:center; padding:4px 10px 10px; flex-wrap:wrap; }
    .toggles button { padding:8px 10px; border-radius:10px; border:1px solid #2a2a2a; background:#1f2937; color:#dbeafe; font-weight:600; }
    .hint { text-align:center; color:#a3a3a3; font-size:12px; padding: 6px 0 10px; }
  </style>
</head>
<body>
  <header><h1>üåå Saturno em Realidade Aumentada ‚Äî com narra√ß√£o por voz</h1></header>

  <model-viewer id="mv"
    src="saturno.glb"
    ar
    ar-modes="webxr scene-viewer"      <!-- prioriza WebXR para manter a p√°gina ativa -->
    ar-placement="floor"
    ar-hit-test
    camera-controls
    auto-rotate
    rotation-per-second="25deg"
    shadow-intensity="1"
    exposure="1"
    alt="Modelo 3D de Saturno em RA">
  </model-viewer>

  <div class="toolbar">
    <button id="ar-webxr">AR com intera√ß√£o (WebXR)</button>
    <button id="ar-compat">AR (compatibilidade)</button>
  </div>

  <div class="toggles">
    <button id="toggle-voice">üîä Voz: ativada</button>
    <button id="test-voice">‚ñ∂Ô∏è Testar voz</button>
  </div>

  <p class="hint">
    Dica: no Android/Chrome, toque em ‚ÄúAR com intera√ß√£o (WebXR)‚Äù. Se n√£o ouvir √°udio, aumente o <em>Volume de m√≠dia</em> e saia do modo silencioso.
  </p>

  <script>
    const mv = document.getElementById('mv');
    const btnARWebXR = document.getElementById('ar-webxr');
    const btnARCompat = document.getElementById('ar-compat');
    const btnToggleVoice = document.getElementById('toggle-voice');
    const btnTestVoice = document.getElementById('test-voice');

    // ====== NARRA√á√ÉO POR VOZ (TTS) ======
    let voiceOn = true;
    let ptVoice = null;

    // Carrega vozes dispon√≠veis (pode demorar 1-2s)
    function pickPtVoice() {
      const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      // Preferir pt-BR; sen√£o, qualquer pt-*
      ptVoice = voices.find(v => /^pt-BR/i.test(v.lang))
             || voices.find(v => /^pt/i.test(v.lang))
             || null;
    }
    if ('speechSynthesis' in window) {
      pickPtVoice();
      speechSynthesis.onvoiceschanged = pickPtVoice;
    }

    function speak(text) {
      if (!voiceOn || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      u.rate = 1;   // velocidade
      u.pitch = 1;  // tom
      u.volume = 1; // volume
      if (ptVoice) u.voice = ptVoice;
      try { speechSynthesis.cancel(); } catch(e) {}
      speechSynthesis.speak(u);
    }

    // Texto curto para iniciar quando a RA come√ßar
    const intro = "Este √© Saturno, o segundo maior planeta do Sistema Solar. Seus an√©is s√£o compostos principalmente por gelo de √°gua e poeira. Entre suas muitas luas, destacam-se Tit√£ e Enc√©lado.";

    // ====== ENTRADA EM RA ======
    // For√ßa WebXR para manter a p√°gina ativa (chat/voz continuam durante a AR)
    btnARWebXR.addEventListener('click', async () => {
      try {
        // ‚ÄòDesbloqueia‚Äô as vozes por gesto do usu√°rio (alguns navegadores exigem)
        if ('speechSynthesis' in window) speechSynthesis.getVoices();
        if (navigator.xr && await navigator.xr.isSessionSupported('immersive-ar')) {
          mv.setAttribute('ar-modes', 'webxr');
        }
      } catch(e) { /* segue mesmo assim */ }
      if (mv.enterAR) mv.enterAR();
    });

    // Compatibilidade (pode abrir Scene Viewer / Quick Look e a p√°gina pausa; voz n√£o roda nesse fluxo)
    btnARCompat.addEventListener('click', () => {
      mv.setAttribute('ar-modes', 'scene-viewer quick-look webxr');
      if (mv.enterAR) mv.enterAR();
    });

    // Quando a sess√£o AR come√ßa via WebXR, iniciamos a narra√ß√£o
    mv.addEventListener('ar-status', (ev) => {
      const status = ev.detail.status || ev.detail;
      // Poss√≠veis statuses: "not-presenting", "session-started", "object-placed"
      if (status === 'session-started') {
        // Fala a introdu√ß√£o ao entrar no AR
        speak(intro);
      }
      if (status === 'not-presenting') {
        // Saiu do AR: interrompe qualquer fala pendente
        if ('speechSynthesis' in window) speechSynthesis.cancel();
      }
    });

    // ====== CONTROLES DE VOZ ======
    btnToggleVoice.addEventListener('click', () => {
      voiceOn = !voiceOn;
      btnToggleVoice.textContent = voiceOn ? 'üîä Voz: ativada' : 'üîá Voz: desativada';
      if (!voiceOn && 'speechSynthesis' in window) speechSynthesis.cancel();
    });

    btnTestVoice.addEventListener('click', () => {
      speak("Teste de voz. Se voc√™ est√° ouvindo, a narra√ß√£o funcionar√° quando a realidade aumentada come√ßar.");
    });
  </script>
</body>
</html>
